# 開発ワークフロー（SDD + TDD）

このプロジェクトでは、**仕様駆動開発（SDD）**と**テスト駆動開発（TDD）**を組み合わせて開発を進めます。

## 開発フロー（全7フェーズ）

### 1. 理解フェーズ 📖

**目的**: 参考コードを分析し、要件と設計を理解する

**作業内容**:
- `reference/` の該当パターンのコードを読む
- アーキテクチャ、データフロー、依存関係を理解する
- ビジネス要件と技術的課題を把握する
- `notes/` にメモを作成

**Claude Codeへの指示例**:
- "synchronous_patternの参考コードを分析して、要件とアーキテクチャを説明して"
- "このパターンが解決する課題とユースケースを教えて"

---

### 2. 仕様策定フェーズ 📋 ← **仕様駆動開発**

**目的**: 実装する内容を明確に定義する

**作業内容**:
- `SPECIFICATION.md` を作成する
- 以下を明確に定義：
  - **要件定義**: 機能要件と非機能要件
  - **アーキテクチャ設計**: システム構成、コンポーネント設計
  - **API仕様**: エンドポイント、入出力形式、エラーレスポンス
  - **データモデル**: データ構造、スキーマ
  - **成功基準**: 何を持って完成とするか
- 仕様をClaude Codeとレビュー・議論する

**Claude Codeへの指示例**:
- "同期推論パターンのSPECIFICATION.mdを作成して。要件定義から始めて"
- "API仕様を詳細に定義して。エンドポイント、入出力、エラーレスポンスを含めて"

**テンプレート**: `templates/SPECIFICATION.template.md`

---

### 3. テスト設計フェーズ 🧪 ← **テスト駆動開発（Red）**

**目的**: 仕様に基づいてテストを先に書く

**作業内容**:
- 仕様に基づいてテストケースを作成
- テストの種類：
  - **ユニットテスト**: 個々の関数・クラスのテスト
  - **統合テスト**: コンポーネント間の連携テスト
  - **E2Eテスト**: システム全体の動作テスト
- まず**失敗するテストを書く**（Red）
- `pytest` で実行してテストが失敗することを確認

**Claude Codeへの指示例**:
- "仕様書に基づいてユニットテストを作成して。まず失敗するテストから"
- "統合テストのテストケースを追加して"

**テンプレート**: `templates/test_unit.template.py`, `test_integration.template.py`

**実行コマンド**:
```bash
pytest tests/ -v  # テストが失敗する（Red）ことを確認
```

---

### 4. 実装フェーズ 💻 ← **テスト駆動開発（Green）**

**目的**: テストを通すための実装を行う

**作業内容**:
- `my_implementations/` にゼロから実装
- テストを通すための**最小限の実装から始める**
- 段階的に機能を拡張
- 各ステップでテストを実行してGreenにする
- コードはシンプルから始めて段階的に拡張
- 参考コードは見てもよいが、**コピペはしない**

**Claude Codeへの指示例**:
- "最初のテストを通すための最小限の実装をして"
- "次の機能を実装して、テストを段階的にGreenにして"

**実行コマンド**:
```bash
pytest tests/ -v  # テストが通る（Green）ことを確認
```

---

### 5. リファクタリングフェーズ ♻️ ← **テスト駆動開発（Refactor）**

**目的**: テストを保ったままコードを改善する

**作業内容**:
- テストが通った状態でコードを改善
- 以下を意識：
  - コードの可読性向上
  - 重複の削除（DRY原則）
  - 適切な抽象化
  - パフォーマンス最適化
- リファクタリング後も**テストがGreenであることを確認**

**Claude Codeへの指示例**:
- "実装をレビューして、改善点を提案して"
- "パフォーマンスを最適化して、テストが通ることを確認して"

**実行コマンド**:
```bash
pytest tests/ -v --cov=src --cov-report=html  # テストがパスし、カバレッジを確認
```

---

### 6. 検証フェーズ ✅

**目的**: 実装が仕様を満たしているか確認する

**作業内容**:
- 実装したコードを実際に動かして確認
- ログやメトリクスを確認
- 仕様書の成功基準を満たしているか検証
- エッジケースやエラーハンドリングの確認
- 負荷テスト（必要に応じて）

**Claude Codeへの指示例**:
- "実装したコードを実際に動かして動作確認して"
- "エラーケースのハンドリングを確認して"

**チェックリスト**:
```bash
# 1. フォーマット
black src/ tests/

# 2. リント
ruff check src/ tests/

# 3. 型チェック
mypy src/

# 4. テスト（カバレッジ付き）
pytest tests/ -v --cov=src --cov-report=html
```

---

### 7. 振り返りフェーズ 📊

**目的**: 学習内容を記録し、次に活かす

**作業内容**:
- `progress/learning_log.md` に学習内容を記録
- 学んだこと、疑問点、改善点をまとめる
- 仕様と実装のギャップを分析
- 次のパターンへの接続を考える
- コードレビュー（自己レビュー）を実施

**記録すべき内容**:
- 実装したパターン名と日時
- 学んだこと
- 躓いた点とその解決方法
- 改善できる点
- 次回への持ち越し事項

---

## TDDサイクル（Red-Green-Refactor）

```
┌─────────────────────────────────────┐
│  1. 仕様を書く（SPECIFICATION.md） │
└──────────────┬──────────────────────┘
               ↓
┌──────────────────────────────────────┐
│  2. テストを書く（失敗するテスト）  │ ← Red
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────┐
│  3. 実装する（テストを通す）    │ ← Green
└──────────────┬───────────────────┘
               ↓
┌──────────────────────────────┐
│  4. リファクタリングする    │ ← Refactor
└──────────────┬───────────────┘
               ↓
      テストが通っているか？
               ↓
          [次の機能へ]
```

---

## 重要な原則

### DO（すべきこと）

- ✅ **仕様を先に書く**: 何を作るかを明確にする
- ✅ **テストを先に書く**: 失敗するテストから始める
- ✅ **小さなステップで進む**: 一度にひとつの機能を実装
- ✅ **頻繁にテストを実行**: 各ステップでグリーンを確認
- ✅ **リファクタリングを恐れない**: グリーンの状態で改善
- ✅ **学習を記録する**: 後から見返せるようにメモを取る

### DON'T（避けるべきこと）

- ❌ **テストなしで実装しない**: テストは後回しにしない
- ❌ **一気に全部実装しない**: 段階的に進める
- ❌ **参考コードをコピペしない**: 自分で考えて実装する
- ❌ **テストが失敗している状態を放置しない**: 必ずグリーンに戻す
- ❌ **仕様が不明確なまま進めない**: 分からないことは質問する

---

## ファイル構成のベストプラクティス

各パターンの実装ディレクトリには以下を含める:

```
ch{N}__{pattern_name}/
├── SPECIFICATION.md           # 仕様書（SDD）
├── README.md                  # 実装の説明
├── pyproject.toml             # プロジェクト設定
├── .python-version            # Pythonバージョン指定
├── src/
│   └── {pattern_name}/
│       ├── __init__.py
│       ├── main.py            # エントリーポイント
│       └── ...                # その他のモジュール
└── tests/
    ├── __init__.py
    ├── test_unit.py           # ユニットテスト
    ├── test_integration.py    # 統合テスト
    └── test_e2e.py            # E2Eテスト（必要に応じて）
```

---

## タスク完了の定義（Definition of Done）

以下をすべて満たしたら、そのパターンは完了とみなす:

- [ ] SPECIFICATION.mdが作成されている
- [ ] すべてのテストがパスする（Green）
- [ ] コードカバレッジが80%以上
- [ ] フォーマット、リント、型チェックがすべてパス
- [ ] README.mdが作成されている
- [ ] 実際に動作確認ができている
- [ ] progress/learning_log.mdに記録されている

---

## トラブルシューティング

### テストが通らない場合

1. エラーメッセージを読む
2. デバッガやprintデバッグで原因を特定
3. 最小限の修正で修正
4. 再度テストを実行

### 仕様が不明確な場合

1. Claude Codeに質問する
2. 参考コードを再度確認する
3. 仕様を明確化してからコードを書く

### 設計に迷った場合

1. 複数の選択肢をリストアップ
2. Claude Codeと議論する
3. シンプルな方から試す（YAGNI原則）
