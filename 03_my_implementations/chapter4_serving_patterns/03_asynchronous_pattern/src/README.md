# Asynchronous Pattern - ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨ä½“æ¦‚è¦

## ğŸ“š ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€**Asynchronous Patternï¼ˆéåŒæœŸæ¨è«–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰** ã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

Asynchronous Patternã¯ã€**æ¨è«–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨æ¨è«–å®Ÿè¡Œã‚’åˆ†é›¢**ã—ã€ã‚­ãƒ¥ãƒ¼çµŒç”±ã§éåŒæœŸå‡¦ç†ã™ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ï¼š

- **Proxy Service**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ã¨job_idç™ºè¡Œã®ã¿ï¼ˆæ¨è«–ã¯ã—ãªã„ï¼‰
- **Worker Service**: Redisã‚­ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—ã—ã¦æ¨è«–å®Ÿè¡Œ
- **Redis**: ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ + ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ¦ãƒ¼ã‚¶ãƒ¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP Request
                         â”‚ POST /predict (ãƒ‡ãƒ¼ã‚¿é€ä¿¡)
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Proxy Service (ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®proxy/)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚   app    â”‚ â†’ â”‚  Redis   â”‚                               â”‚
â”‚  â”‚ FastAPI  â”‚   â”‚ Client   â”‚                               â”‚
â”‚  â”‚ ãƒ«ãƒ¼ã‚¿ãƒ¼ â”‚   â”‚ LPUSH    â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                      â”‚ LPUSH job_id                         â”‚
â”‚                      â”‚ SET job:{job_id}:data                â”‚
â”‚                      â”‚ SET job:{job_id}:status = "pending" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚                                      â”‚
â”‚              Redis (ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ + ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢)             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ predict_queue (Listå‹)            â”‚                   â”‚
â”‚    â”‚ - job_id ã®ã‚­ãƒ¥ãƒ¼                 â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ job:{job_id}:data (Stringå‹)      â”‚                   â”‚
â”‚    â”‚ - å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰               â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ job:{job_id}:status (Stringå‹)    â”‚                   â”‚
â”‚    â”‚ - pending / processing / completedâ”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ BRPOP job_id (ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¾…æ©Ÿ)
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Service (ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®backend/)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  worker  â”‚ â†’ â”‚   ONNX   â”‚ â†’ â”‚  Redis   â”‚               â”‚
â”‚  â”‚ BRPOPç›£è¦–â”‚   â”‚ Runtime  â”‚   â”‚  Client  â”‚               â”‚
â”‚  â”‚ç„¡é™ãƒ«ãƒ¼ãƒ—â”‚   â”‚   æ¨è«–   â”‚   â”‚çµæœä¿å­˜  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                      â”‚ SET job:{job_id}:result â”‚
â”‚                                      â”‚ SET job:{job_id}:status = "completed" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â†“
                                  çµæœã‚’Redisã«ä¿å­˜
```

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
src/
â”œâ”€â”€ README.md                    # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå…¨ä½“æ¦‚è¦ï¼‰
â”‚
â”œâ”€â”€ proxy/                       # FastAPI Proxyã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ app.py                  # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©
â”‚
â”œâ”€â”€ backend/                     # Workerã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ worker.py               # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆBRPOPç›£è¦–ï¼‰
â”‚   â””â”€â”€ onnx_client.py          # ONNX Runtimeæ¨è«–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚
â”œâ”€â”€ utils/                       # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ redis_client.py         # Redisæ“ä½œã‚¯ãƒ©ã‚¹
â”‚
â”œâ”€â”€ configurations.py            # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
â””â”€â”€ models.py                   # Pydanticãƒ¢ãƒ‡ãƒ«å®šç¾©
```

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆç°¡å˜ãªä¾‹ï¼‰

### ä¾‹ï¼šIrisãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸæ¨è«–ã™ã‚‹å ´åˆ

```python
# ========================================
# ãƒ•ã‚§ãƒ¼ã‚º1: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ï¼ˆå³åº§ã«å®Œäº†ï¼‰
# ========================================

# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
POST /predict
Body: {"data": [[5.1, 3.5, 1.4, 0.2]]}

# 2. proxy/app.py ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡
@app.post("/predict")
def predict(request: PredictRequest) -> PredictResponse:
    # job_idç”Ÿæˆï¼ˆUUIDï¼‰
    job_id = str(uuid.uuid4())[:6]  # ä¾‹: "a3f7b2"

    # Redisã«ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜
    redis_client.save_job_data(
        job_id=job_id,
        data=request.data,
        queue_name="predict_queue"
    )
    # å†…éƒ¨å‡¦ç†:
    #   - SET job:a3f7b2:data "[[5.1, 3.5, 1.4, 0.2]]"
    #   - SET job:a3f7b2:status "pending"
    #   - LPUSH predict_queue "a3f7b2"

    # å³åº§ã«job_idã‚’è¿”å´ï¼ˆæ¨è«–å¾…ãŸãªã„ï¼ï¼‰
    return {"job_id": job_id}  # < 10ms

# ========================================
# ãƒ•ã‚§ãƒ¼ã‚º2: éåŒæœŸæ¨è«–ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
# ========================================

# 3. backend/worker.py ãŒç„¡é™ãƒ«ãƒ¼ãƒ—ã§ç›£è¦–
class PredictionWorker:
    def run(self):
        while True:
            # ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ã‚¸ãƒ§ãƒ–ã‚’å–å¾—ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
            # ã‚¸ãƒ§ãƒ–ãŒæ¥ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆCPUåŠ¹ç‡çš„ï¼ï¼‰
            job_id = redis_client.dequeue_blocking(
                "predict_queue",
                timeout=1  # 1ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            )
            # å†…éƒ¨å‡¦ç†: BRPOP predict_queue 1

            if job_id:
                self.process_job(job_id)

# 4. ã‚¸ãƒ§ãƒ–å‡¦ç†
def process_job(job_id: str):
    # 4-1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    redis_client.set_job_status(job_id, "processing")
    # SET job:a3f7b2:status "processing"

    # 4-2. ãƒ‡ãƒ¼ã‚¿å–å¾—
    data = redis_client.get_job_data(job_id)
    # GET job:a3f7b2:data â†’ [[5.1, 3.5, 1.4, 0.2]]

    # 4-3. æ¨è«–å®Ÿè¡Œï¼ˆONNX Runtimeï¼‰
    results = onnx_client.predict(data)
    # ONNX Runtimeæ¨è«–ï¼ˆç´„10-50msï¼‰

    # 4-4. çµæœä¿å­˜
    redis_client.save_job_result(
        job_id=job_id,
        result=results[0]  # {prediction: 0, class_name: "setosa", ...}
    )
    # SET job:a3f7b2:result "{...}"
    # SET job:a3f7b2:status "completed"

# ========================================
# ãƒ•ã‚§ãƒ¼ã‚º3: çµæœå–å¾—
# ========================================

# 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµæœã‚’å–å¾—
GET /job/a3f7b2

# 6. proxy/app.py ã§DBã‹ã‚‰çµæœã‚’å–å¾—
@app.get("/job/{job_id}")
def get_job_result(job_id: str) -> JobResult:
    # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
    status = redis_client.get_job_status(job_id)
    # GET job:a3f7b2:status â†’ "completed"

    # çµæœå–å¾—ï¼ˆå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿ï¼‰
    if status == "completed":
        result = redis_client.get_job_result(job_id)
        # GET job:a3f7b2:result â†’ {...}
        return {
            "job_id": job_id,
            "status": "completed",
            "result": result
        }
    else:
        return {
            "job_id": job_id,
            "status": "pending",  # ã¾ãŸã¯ "processing"
            "result": None
        }

# æ¨è«–å®Œäº†å‰: {"job_id": "a3f7b2", "status": "pending", "result": null}
# æ¨è«–å®Œäº†å¾Œ: {"job_id": "a3f7b2", "status": "completed", "result": {...}}
```

## ğŸš€ ä¸»è¦ãªã‚¯ãƒ©ã‚¹ã¨ãã®å½¹å‰²

### 1. FastAPI Application (`proxy/app.py`)
- **å½¹å‰²**: HTTPã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œï¼ˆProxyï¼‰
- **ã‚„ã‚‹ã“ã¨**:
  - `POST /predict`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ã€job_idç™ºè¡Œã€Redisã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²
  - `GET /job/{job_id}`: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»çµæœå–å¾—
  - `GET /health`: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

### 2. PredictionWorker (`backend/worker.py`)
- **å½¹å‰²**: Redisã‚­ãƒ¥ãƒ¼ã‚’ç›£è¦–ã—ã¦æ¨è«–ã‚’å®Ÿè¡Œ
- **ã‚„ã‚‹ã“ã¨**:
  - `run()`: ç„¡é™ãƒ«ãƒ¼ãƒ—ã§BRPOPç›£è¦–
  - `process_job()`: ã‚¸ãƒ§ãƒ–å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾— â†’ æ¨è«– â†’ çµæœä¿å­˜ï¼‰
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆpending â†’ processing â†’ completedï¼‰

### 3. ONNXClient (`backend/onnx_client.py`)
- **å½¹å‰²**: ONNX Runtimeæ¨è«–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- **ã‚„ã‚‹ã“ã¨**:
  - `predict()`: Irisãƒ‡ãƒ¼ã‚¿ â†’ ç¢ºç‡åˆ†å¸ƒ
  - ONNXãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰
  - ãƒ©ãƒ™ãƒ«å¤‰æ›ï¼ˆ0 â†’ "setosa"ï¼‰

### 4. RedisClient (`utils/redis_client.py`)
- **å½¹å‰²**: Redisæ“ä½œã®æŠ½è±¡åŒ–
- **ã‚„ã‚‹ã“ã¨**:
  - `save_job_data()`: ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜ã€ã‚­ãƒ¥ãƒ¼ã«ç™»éŒ²
  - `dequeue_blocking()`: BRPOPã§ã‚¸ãƒ§ãƒ–ã‚’å–å¾—ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
  - `get_job_data()` / `save_job_result()`: ãƒ‡ãƒ¼ã‚¿ãƒ»çµæœã®å–å¾—/ä¿å­˜
  - `set_job_status()` / `get_job_status()`: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

### 5. Pydanticãƒ¢ãƒ‡ãƒ« (`models.py`)
- **å½¹å‰²**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- **ã‚„ã‚‹ã“ã¨**:
  - `PredictRequest`: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
  - `PredictResponse`: job_id
  - `JobResult`: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨çµæœ
  - `PredictionResult`: æ¨è«–çµæœï¼ˆã‚¯ãƒ©ã‚¹ã€ç¢ºç‡ï¼‰

## ğŸ”‘ é‡è¦ãªæ¦‚å¿µ

### ãªãœæ¨è«–ã‚’éåŒæœŸåŒ–ã™ã‚‹ã®ã‹ï¼Ÿ

**åŒæœŸæ¨è«–ï¼ˆWeb Single Patternï¼‰ã®å•é¡Œ**:
```python
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¨è«–å®Œäº†ã¾ã§å¾…ã¤å¿…è¦ãŒã‚ã‚‹ï¼ˆé…ã„ï¼‰
POST /predict â†’ æ¨è«–å®Ÿè¡Œï¼ˆ100msï¼‰ â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹
# å•é¡Œ: ã‚¹ãƒ‘ã‚¤ã‚¯ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

**éåŒæœŸæ¨è«–ï¼ˆAsynchronous Patternï¼‰ã®åˆ©ç‚¹**:
```python
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ã¯å³åº§ã«å®Œäº†ï¼ˆé€Ÿã„ï¼‰
POST /predict â†’ Redisã«ç™»éŒ²ï¼ˆ5msï¼‰ â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆjob_idè¿”å´ï¼‰

# æ¨è«–ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
Worker BRPOP â†’ æ¨è«–å®Ÿè¡Œ â†’ çµæœä¿å­˜
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹é«˜é€ŸåŒ–**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ãŒå³åº§ã«å®Œäº†ï¼ˆ< 10msï¼‰
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: Workerã‚’ç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆå¯èƒ½
- **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Š**: è¤‡æ•°Workerã§ä¸¦åˆ—å‡¦ç†

### BRPOPã¨ã¯ï¼Ÿï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°æ–¹å¼ï¼‰

Redisã®**BRPOPï¼ˆBlocking Right POPï¼‰**ã‚³ãƒãƒ³ãƒ‰ã¯ã€ã‚­ãƒ¥ãƒ¼ãŒç©ºã®å ´åˆã«ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå¾…æ©Ÿï¼‰ã—ã¾ã™ã€‚

**å¾“æ¥ã®ãƒãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ã®å•é¡Œ**:
```python
# CPUç„¡é§„é£ã„ã€é…å»¶ã‚ã‚Š
while True:
    job_id = redis.rpop("predict_queue")
    if not job_id:
        time.sleep(0.1)  # 100msé…å»¶ã€CPUä½¿ç”¨
```

**BRPOPæ–¹å¼ã®åˆ©ç‚¹**:
```python
# ã‚¸ãƒ§ãƒ–ãŒæ¥ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆCPUåŠ¹ç‡çš„ï¼‰
while True:
    job_id = redis.brpop("predict_queue", timeout=1)
    # ã‚¸ãƒ§ãƒ–ãŒæ¥ãŸã‚‰å³åº§ã«å‡¦ç†ï¼ˆé…å»¶ãªã—ï¼‰
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- **CPUåŠ¹ç‡**: ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã®CPUä½¿ç”¨ç‡ãŒã»ã¼ã‚¼ãƒ­
- **ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·**: ã‚¸ãƒ§ãƒ–åˆ°ç€æ™‚ã«å³åº§ã«å‡¦ç†é–‹å§‹
- **Redisè² è·è»½æ¸›**: ãƒãƒ¼ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹ç„¡é§„ãªã‚¯ã‚¨ãƒªãŒãªã„

### Redisã®ã‚­ãƒ¼è¨­è¨ˆ

Asynchronous Patternã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚­ãƒ¼è¨­è¨ˆã§ã‚¸ãƒ§ãƒ–ã‚’ç®¡ç†ã—ã¾ã™ï¼š

```
predict_queue (Listå‹)
â””â”€ job_id ã®ã‚­ãƒ¥ãƒ¼ï¼ˆLPUSH/BRPOPï¼‰

job:{job_id}:data (Stringå‹)
â””â”€ å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONæ–‡å­—åˆ—ï¼‰

job:{job_id}:status (Stringå‹)
â””â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpending / processing / completed / failedï¼‰

job:{job_id}:result (Stringå‹)
â””â”€ æ¨è«–çµæœï¼ˆJSONæ–‡å­—åˆ—ï¼‰

job:{job_id}:error (Stringå‹)
â””â”€ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¤±æ•—æ™‚ï¼‰
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»**:
```
pending â†’ processing â†’ completed
                    â””â†’ failedï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
```

### ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

docker-compose.ymlã§`replicas: 2`ã‚’è¨­å®šã™ã‚‹ã¨ã€**è¤‡æ•°ã®WorkerãŒä¸¦åˆ—ã§ã‚¸ãƒ§ãƒ–ã‚’å‡¦ç†**ã—ã¾ã™ï¼š

```yaml
worker:
  deploy:
    replicas: 2  # 2ã¤ã®Workerã‚’èµ·å‹•
```

**å‹•ä½œ**:
1. Worker1ã¨Worker2ãŒåŒæ™‚ã«BRPOPã§å¾…æ©Ÿ
2. ã‚¸ãƒ§ãƒ–ãŒæ¥ãŸã‚‰ã€**å…ˆç€é †ã§1ã¤ã®Workerã ã‘ãŒã‚¸ãƒ§ãƒ–ã‚’å–å¾—**ï¼ˆé‡è¤‡ãªã—ï¼‰
3. å„WorkerãŒç‹¬ç«‹ã—ã¦æ¨è«–å®Ÿè¡Œ
4. ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆå‘ä¸Šï¼ˆä¸¦åˆ—å‡¦ç†ã§å‡¦ç†é€Ÿåº¦ãŒ2å€ï¼‰

### Batch Patternã¨ã®é•ã„

| é …ç›® | Asynchronous Pattern | Batch Pattern |
|------|---------------------|---------------|
| **æ¨è«–ã‚¿ã‚¤ãƒŸãƒ³ã‚°** | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«å³åº§ | å®šæœŸçš„ï¼ˆ60ç§’ã”ã¨ï¼‰ |
| **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·** | ä½ï¼ˆæ•°ç§’ä»¥å†…ï¼‰ | é«˜ï¼ˆæœ€å¤§60ç§’ï¼‰ |
| **ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** | é«˜ï¼ˆWorkeræ•°ã«æ¯”ä¾‹ï¼‰ | ä¸­ï¼ˆä¸¦åˆ—åº¦å›ºå®šï¼‰ |
| **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡** | ä¸­ï¼ˆå¸¸æ™‚ç¨¼åƒï¼‰ | é«˜ï¼ˆãƒãƒƒãƒæ™‚ã®ã¿ï¼‰ |
| **é©ç”¨å ´é¢** | æº–ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨è«– | å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸå‡¦ç† |

## ğŸ¯ éåŒæœŸãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé©ã—ã¦ã„ã‚‹å ´åˆ

**âœ… é©ã—ã¦ã„ã‚‹**:
- æº–ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨è«–ï¼ˆæ•°ç§’ä»¥å†…ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹OKï¼‰
- ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«ã‚¹ãƒ‘ã‚¤ã‚¯ãŒã‚ã‚‹
- Workerã‚’ç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã—ãŸã„
- æ¨è«–å‡¦ç†ãŒé‡ã„ï¼ˆ100msä»¥ä¸Šï¼‰

**âŒ é©ã—ã¦ã„ãªã„**:
- å®Œå…¨ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¨è«–ãŒå¿…è¦ï¼ˆ< 100msï¼‰
- ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒå¸¸ã«ä¸€å®š
- Redisã®é‹ç”¨ãŒé›£ã—ã„

## ğŸ› ï¸ é–‹ç™ºæ™‚ã®æ³¨æ„ç‚¹

### Redisã®æ°¸ç¶šåŒ–

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯Redisã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®ã¿ã§ã€å†èµ·å‹•ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯æ°¸ç¶šåŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ï¼š

```yaml
redis:
  command: redis-server --appendonly yes
  volumes:
    - redis_data:/data
```

### TTLï¼ˆæœ‰åŠ¹æœŸé™ï¼‰è¨­å®š

å¤ã„ã‚¸ãƒ§ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹ãŸã‚ã€TTLï¼ˆTime To Liveï¼‰ã‚’è¨­å®šã—ã¾ã™ï¼š

```python
# configurations.py
class CacheConfig:
    job_ttl = 3600  # 1æ™‚é–“ã§è‡ªå‹•å‰Šé™¤
```

### ç’°å¢ƒå¤‰æ•°

```yaml
environment:
  REDIS_HOST: redis        # Redisãƒ›ã‚¹ãƒˆå
  REDIS_PORT: 6379        # Redisãƒãƒ¼ãƒˆ
  QUEUE_NAME: predict_queue  # ã‚­ãƒ¥ãƒ¼å
  BRPOP_TIMEOUT: 1        # BRPOPã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
  PREDICTION_TIMEOUT: 10  # æ¨è«–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
```

## ğŸ¯ ã¾ã¨ã‚

ã“ã®Asynchronous Patternã®å®Ÿè£…ã¯ã€ä»¥ä¸‹ã®3ã¤ã®ä¸»è¦éƒ¨åˆ†ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **proxy/**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ã¨job_idç™ºè¡Œï¼ˆæ¨è«–ã¯ã—ãªã„ï¼‰
2. **backend/**: Redisã‚­ãƒ¥ãƒ¼ã‚’ç›£è¦–ã—ã¦æ¨è«–å®Ÿè¡Œ
3. **utils/**: Redisæ“ä½œã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

å…¨ä½“ã¨ã—ã¦ã€**æ¨è«–ã‚’éåŒæœŸåŒ–ã™ã‚‹ã“ã¨ã§ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé«˜é€ŸåŒ–ã—ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªæ¨è«–ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã‚‹**ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
