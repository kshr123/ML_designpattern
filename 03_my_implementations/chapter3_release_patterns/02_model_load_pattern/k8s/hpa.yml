# ==============================================================================
# HorizontalPodAutoscaler（HPA）定義
# ==============================================================================
# HPAは、負荷に応じてPod数を自動的にスケーリングする
#
# 【役割】
#   - CPU使用率やメモリ使用率に応じてPod数を増減
#   - トラフィック増加時: Pod数を増やして負荷分散
#   - トラフィック減少時: Pod数を減らしてコスト削減
#
# 【動作】
#   1. メトリクス（CPU/メモリ）を監視
#   2. 閾値を超えたらPod数を増やす
#   3. 閾値を下回ったらPod数を減らす
#   4. minReplicas と maxReplicas の範囲内でスケール
#
# 【前提条件】
#   - Deployment でリソース requests が設定されていること
#   - metrics-server がインストールされていること
# ==============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: model-load-pattern-hpa
  namespace: model-load-pattern  # このHPAが属する名前空間
  labels:
    app: model-load-pattern

spec:
  # ----------------------------------------------------------------------------
  # スケーリング対象（どのDeploymentをスケールするか）
  # ----------------------------------------------------------------------------
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: model-load-pattern  # スケール対象のDeployment名

  # ----------------------------------------------------------------------------
  # レプリカ数の範囲
  # ----------------------------------------------------------------------------
  minReplicas: 2   # 最小Pod数（これより少なくならない）
  maxReplicas: 5   # 最大Pod数（これより多くならない）

  # ----------------------------------------------------------------------------
  # メトリクス（スケーリングの基準）
  # ----------------------------------------------------------------------------
  # 複数のメトリクスを指定可能
  # いずれかのメトリクスが閾値を超えたらスケールアウト
  # ----------------------------------------------------------------------------
  metrics:
    # CPU使用率ベースのスケーリング
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70  # CPU使用率が70%を超えたらスケールアウト

    # メモリ使用率ベースのスケーリング
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80  # メモリ使用率が80%を超えたらスケールアウト

# ==============================================================================
# スケーリングの例
# ==============================================================================
#
# 【スケールアウト（Pod数を増やす）】
#   条件: CPU使用率 > 70% または メモリ使用率 > 80%
#   動作: Pod数を徐々に増やす（最大5個まで）
#
# 【スケールイン（Pod数を減らす）】
#   条件: CPU使用率 < 70% かつ メモリ使用率 < 80%
#   動作: Pod数を徐々に減らす（最小2個まで）
#
# 【例】
#   1. 初期状態: 2 Pods（minReplicas）
#   2. トラフィック増加 → CPU 80% → 3 Pods にスケールアウト
#   3. さらに増加 → CPU 90% → 4 Pods にスケールアウト
#   4. トラフィック減少 → CPU 50% → 3 Pods にスケールイン
#   5. さらに減少 → CPU 30% → 2 Pods にスケールイン（minReplicas）
# ==============================================================================
